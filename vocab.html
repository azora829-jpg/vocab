<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabMaster Pro V6 (GitHub Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --selected-bg: #e0e7ff;
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --secondary: #94a3b8;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-sidebar: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --selected-bg: #312e81;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 300px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--text-main); font-weight: 300; font-size: 0.9rem; }

        .control-panel { background: var(--bg-body); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .panel-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; display: block; }

        /* Buttons & Inputs */
        button { cursor: pointer; border: none; border-radius: 6px; padding: 10px; font-weight: 600; font-size: 0.9rem; width: 100%; transition: 0.2s; margin-bottom: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        
        input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); margin-bottom: 8px; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        .range-inputs { display: flex; gap: 5px; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; position: relative; }

        /* INPUT BAR */
        .input-bar {
            background: var(--bg-card); padding: 15px; border-radius: 10px; 
            box-shadow: 0 4px 15px -5px rgba(0,0,0,0.1); border: 1px solid var(--border);
            margin-bottom: 20px; display: flex; gap: 10px; flex-direction: column;
        }
        
        .input-row { display: flex; gap: 10px; position: relative; }
        
        .realtime-status {
            font-size: 0.85rem; padding: 5px 10px; border-radius: 4px; display: none; margin-top: 5px;
        }
        .status-exists { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; display: block; }
        .status-new { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; display: block; }

        /* LIST/TABLE */
        .list-container { flex: 1; overflow-y: auto; padding-right: 5px; }
        
        .vocab-item {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 10px; transition: all 0.2s; position: relative;
        }
        .vocab-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .vocab-item.selected { background: var(--selected-bg); border-color: var(--primary); }
        .vocab-item.completed { border-left: 4px solid var(--success); }

        /* Item Header */
        .item-header {
            padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer;
        }
        
        .word-index { font-size: 0.8rem; color: var(--text-muted); width: 25px; }
        .word-main { font-size: 1.1rem; font-weight: 700; flex: 1; }
        .word-meaning { font-size: 0.9rem; color: var(--text-muted); max-width: 40%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .checkbox-custom {
            width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 4px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .completed .checkbox-custom { background: var(--success); border-color: var(--success); color: white; }

        /* Expanded Details */
        .item-details {
            display: none; padding: 20px; border-top: 1px solid var(--border); background: var(--bg-body);
            animation: slideDown 0.3s ease;
        }
        .expanded .item-details { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .detail-box { display: flex; flex-direction: column; gap: 5px; }
        .detail-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); }
        textarea.edit-field {
            width: 100%; padding: 8px; font-size: 0.9rem; border: 1px solid var(--border);
            border-radius: 6px; background: var(--bg-card); color: var(--text-main); resize: vertical; min-height: 60px;
        }

        /* Chips */
        .chips { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .chip { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; background: #e2e8f0; color: #475569; }
        .chip.ant { background: #fee2e2; color: #991b1b; }

        /* FLASHCARD MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .flashcard {
            background: var(--bg-card); width: 90%; max-width: 600px; height: 400px;
            border-radius: 20px; padding: 40px; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; cursor: pointer;
            transform-style: preserve-3d; transition: transform 0.6s;
        }
        .fc-word { font-size: 3rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; }
        .fc-details { display: none; margin-top: 20px; text-align: left; width: 100%; border-top: 1px solid var(--border); padding-top: 20px; }
        .fc-controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; }

        /* LOADING */
        .spinner { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rot 1s linear infinite; display: none; }
        @keyframes rot { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="app-container">
    
    <aside class="sidebar">
        <div class="logo">VocabMaster <span>Pro</span></div>
        
        <div class="control-panel">
            <span class="panel-label">Study Mode</span>
            <button class="btn-primary" onclick="startFlashcards()">‚ö° Study Flashcards</button>
            <div style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 5px;">
                Only shows uncompleted words
            </div>
        </div>

        <div class="control-panel">
            <span class="panel-label">Filters & Sort</span>
            <select id="sortSelect" onchange="renderList()">
                <option value="newest">üìÖ Newest First</option>
                <option value="alpha">üî§ Alphabetical (A-Z)</option>
                <option value="status">‚úÖ Completed First</option>
                <option value="status_inv">‚¨ú Pending First</option>
            </select>
            <div class="range-inputs">
                <input type="number" id="rangeStart" placeholder="From #">
                <input type="number" id="rangeEnd" placeholder="To #">
            </div>
            <button class="btn-outline" onclick="selectRange()">Select Range</button>
        </div>

        <div class="control-panel">
            <span class="panel-label">Bulk Actions</span>
            <button class="btn-outline" onclick="bulkAction('complete')">Mark Selected Done</button>
            <button class="btn-outline" onclick="bulkAction('delete')" style="color:var(--danger); border-color:var(--danger);">Delete Selected</button>
            <button class="btn-outline" onclick="exportData()">‚¨áÔ∏è Backup Data</button>
            <button class="btn-outline" onclick="toggleTheme()">üåó Toggle Theme</button>
        </div>
        
        <div style="margin-top:auto; font-size:0.8rem; color:var(--text-muted);">
            <span id="totalCount">0</span> Words stored.<br>
            <span id="selCount">0</span> Selected.
        </div>
    </aside>

    <main class="main-content">
        
        <div class="input-bar">
            <div class="input-row">
                <input type="text" id="wordInput" placeholder="Type a new word here (e.g. 'Serendipity')..." autocomplete="off">
                <button class="btn-primary" style="width: auto; padding: 0 30px;" onclick="addWord()">
                    <span id="addBtnText">Add</span>
                    <span class="spinner" id="addSpinner"></span>
                </button>
            </div>
            <div id="statusMsg" class="realtime-status"></div>
        </div>

        <div class="list-container" id="vocabList">
            </div>

    </main>
</div>

<div class="modal-overlay" id="fcModal">
    <div class="flashcard" id="flashcard" onclick="flipCard()">
        <div class="fc-word" id="fcWord">Ready?</div>
        <div style="color:var(--text-muted); font-size:0.9rem;">(Click card to flip)</div>
        
        <div class="fc-details" id="fcDetails">
            <h3 id="fcBangla" style="color:var(--primary);">...</h3>
            <p id="fcDef">...</p>
            <p id="fcNuance" style="font-style:italic; color:var(--text-muted);">...</p>
        </div>

        <div class="fc-controls" onclick="event.stopPropagation()">
            <button class="btn-outline" style="width:100px; background:var(--bg-card);" onclick="nextCard(false)">Still Learning</button>
            <button class="btn-primary" style="width:100px; background:var(--success);" onclick="nextCard(true)">Mastered!</button>
            <button class="btn-outline" style="width:60px; background:var(--bg-card); color:var(--danger); border-color:var(--danger);" onclick="closeFlashcards()">Exit</button>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let db = JSON.parse(localStorage.getItem('vocab_v6_pro')) || [];
    let selectedIds = new Set();
    let lastSelectedIndex = -1; // For Shift+Click
    let studyQueue = [];

    // --- DOM ELEMENTS ---
    const wordInput = document.getElementById('wordInput');
    const listEl = document.getElementById('vocabList');
    const statusMsg = document.getElementById('statusMsg');
    const sortSelect = document.getElementById('sortSelect');
    const totalCount = document.getElementById('totalCount');
    const selCount = document.getElementById('selCount');

    // --- INITIALIZATION ---
    if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    renderList();

    // --- EVENT LISTENERS ---
    
    // Real-time Type Detection & Filter
    wordInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        renderList(val); // Filter list by what's being typed

        if (val.length > 0) {
            const exists = db.some(i => i.word.toLowerCase() === val.toLowerCase());
            if (exists) {
                statusMsg.className = 'realtime-status status-exists';
                statusMsg.innerText = `‚ö†Ô∏è '${val}' is already in your list!`;
            } else {
                statusMsg.className = 'realtime-status status-new';
                statusMsg.innerText = `‚ú® New word! Press Enter to auto-fetch details.`;
            }
        } else {
            statusMsg.style.display = 'none';
        }
    });

    wordInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') addWord();
    });

    // --- CORE LOGIC ---

    async function addWord() {
        const word = wordInput.value.trim();
        if(!word) return;

        // Prevent Duplicate
        if(db.some(i => i.word.toLowerCase() === word.toLowerCase())) {
            alert("Word already exists!"); return;
        }

        // UI Loading
        const btnText = document.getElementById('addBtnText');
        const spinner = document.getElementById('addSpinner');
        btnText.style.display = 'none'; spinner.style.display = 'inline-block';
        wordInput.disabled = true;

        const newEntry = {
            id: Date.now(),
            word: word.charAt(0).toUpperCase() + word.slice(1),
            definition: "",
            bangla: "",
            nuance: "", // Context/Example
            synonyms: [],
            antonyms: [],
            mnemonics: "",
            mistakes: "",
            completed: false,
            created: new Date().toISOString()
        };

        try {
            // PARALLEL API CALLS
            const [dictRes, transRes] = await Promise.allSettled([
                fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`),
                fetch(`https://api.mymemory.translated.net/get?q=${word}&langpair=en|bn`)
            ]);

            // Process Dictionary API
            if(dictRes.status === 'fulfilled' && dictRes.value.ok) {
                const data = await dictRes.value.json();
                const main = data[0];
                const meaning = main.meanings[0];
                
                newEntry.definition = meaning.definitions[0].definition;
                const example = meaning.definitions.find(d => d.example);
                if(example) newEntry.nuance = `Context: "${example.example}"`;

                // Synonyms
                let syns = new Set();
                let ants = new Set();
                main.meanings.forEach(m => {
                    m.synonyms.forEach(s => syns.add(s));
                    m.antonyms.forEach(a => ants.add(a));
                });
                newEntry.synonyms = Array.from(syns).slice(0, 5);
                newEntry.antonyms = Array.from(ants).slice(0, 3);
            }

            // Process Translation API (Bangla)
            if(transRes.status === 'fulfilled' && transRes.value.ok) {
                const data = await transRes.value.json();
                if(data.responseData && data.responseData.translatedText) {
                    newEntry.bangla = data.responseData.translatedText;
                }
            }

        } catch (err) {
            console.error(err);
        }

        db.unshift(newEntry);
        save();
        renderList();
        
        // Reset UI
        wordInput.value = '';
        wordInput.disabled = false;
        btnText.style.display = 'inline'; spinner.style.display = 'none';
        statusMsg.style.display = 'none';
        wordInput.focus();
    }

    // --- RENDERING & SELECTION ---

    function renderList(filterText = '') {
        listEl.innerHTML = '';
        
        let data = [...db];

        // 1. Filter
        if(filterText) {
            data = data.filter(i => i.word.toLowerCase().includes(filterText.toLowerCase()));
        }

        // 2. Sort
        const sortMode = sortSelect.value;
        data.sort((a, b) => {
            if(sortMode === 'alpha') return a.word.localeCompare(b.word);
            if(sortMode === 'status') return (a.completed === b.completed) ? 0 : a.completed ? -1 : 1;
            if(sortMode === 'status_inv') return (a.completed === b.completed) ? 0 : a.completed ? 1 : -1;
            return new Date(b.created) - new Date(a.created); // Default Newest
        });

        // 3. Render
        data.forEach((item, index) => {
            const isSel = selectedIds.has(item.id);
            const el = document.createElement('div');
            el.className = `vocab-item ${item.completed ? 'completed' : ''} ${isSel ? 'selected' : ''}`;
            el.id = `item-${item.id}`;

            const synTags = item.synonyms.map(s => `<span class="chip">${s}</span>`).join('');
            const antTags = item.antonyms.map(a => `<span class="chip ant">${a}</span>`).join('');

            el.innerHTML = `
                <div class="item-header" onclick="handleItemClick(event, ${item.id}, ${index}, this)">
                    <div class="checkbox-custom" onclick="toggleComplete(event, ${item.id})">
                        ${item.completed ? '‚úî' : ''}
                    </div>
                    <div class="word-index">#${db.indexOf(item) + 1}</div>
                    <div class="word-main">
                        ${item.word} 
                        <span style="font-weight:400; font-size:0.9rem; color:var(--primary); margin-left:8px;">${item.bangla}</span>
                    </div>
                    <div class="word-meaning">${item.definition}</div>
                    <button class="btn-outline" style="width:30px; padding:2px;" onclick="toggleDetails(event, ${item.id})">‚ñº</button>
                </div>
                
                <div class="item-details" id="details-${item.id}" onclick="event.stopPropagation()">
                    <div class="details-grid">
                        <div class="detail-box">
                            <span class="detail-label">Definition & Nuance</span>
                            <textarea class="edit-field" onchange="updateField(${item.id}, 'definition', this.value)">${item.definition}</textarea>
                            <textarea class="edit-field" placeholder="Nuance / Context..." onchange="updateField(${item.id}, 'nuance', this.value)">${item.nuance}</textarea>
                        </div>
                        <div class="detail-box">
                            <span class="detail-label">Bangla & Memory Tricks</span>
                            <input type="text" class="edit-field" style="min-height:35px;" value="${item.bangla}" onchange="updateField(${item.id}, 'bangla', this.value)">
                            <textarea class="edit-field" placeholder="Mnemonic / Memory Trick..." onchange="updateField(${item.id}, 'mnemonics', this.value)">${item.mnemonics}</textarea>
                            <input type="text" class="edit-field" style="min-height:35px;" placeholder="Common Mistake?" value="${item.mistakes}" onchange="updateField(${item.id}, 'mistakes', this.value)">
                        </div>
                    </div>
                    <div class="detail-box" style="margin-top:10px;">
                        <span class="detail-label">Related Words</span>
                        <div class="chips">${synTags} ${antTags}</div>
                    </div>
                </div>
            `;
            listEl.appendChild(el);
        });

        // Update Counts
        totalCount.innerText = db.length;
        selCount.innerText = selectedIds.size;
    }

    // --- SELECTION LOGIC ---

    function handleItemClick(e, id, index, el) {
        // Prevent triggering if clicked on checkbox or expand button
        if(e.target.tagName === 'BUTTON' || e.target.classList.contains('checkbox-custom')) return;

        if (e.shiftKey && lastSelectedIndex !== -1) {
            // Range Select logic (Visual based on current sorted view)
            const allItems = Array.from(listEl.children);
            const start = Math.min(lastSelectedIndex, index);
            const end = Math.max(lastSelectedIndex, index);
            
            for(let i=start; i<=end; i++) {
                const itemId = parseInt(allItems[i].id.split('-')[1]);
                selectedIds.add(itemId);
            }
        } else if (e.ctrlKey || e.metaKey) {
            // Toggle Single
            if(selectedIds.has(id)) selectedIds.delete(id);
            else selectedIds.add(id);
            lastSelectedIndex = index;
        } else {
            // Single Select (Clear others)
            selectedIds.clear();
            selectedIds.add(id);
            lastSelectedIndex = index;
        }
        renderList(wordInput.value.trim()); // Re-render to show highlights
    }

    function selectRange() {
        const start = parseInt(document.getElementById('rangeStart').value) - 1;
        const end = parseInt(document.getElementById('rangeEnd').value) - 1;
        if(isNaN(start) || isNaN(end)) return;

        // Select based on current DB order
        selectedIds.clear();
        db.slice(start, end + 1).forEach(item => selectedIds.add(item.id));
        renderList();
    }

    // --- DATA UPDATES ---

    function toggleDetails(e, id) {
        e.stopPropagation();
        const el = document.getElementById(`item-${id}`);
        el.classList.toggle('expanded');
    }

    function toggleComplete(e, id) {
        e.stopPropagation();
        const item = db.find(i => i.id === id);
        item.completed = !item.completed;
        save();
        renderList(wordInput.value.trim());
    }

    function updateField(id, key, val) {
        const item = db.find(i => i.id === id);
        item[key] = val;
        save();
    }

    function bulkAction(action) {
        if(selectedIds.size === 0) return alert("Select items first!");
        
        if(action === 'delete') {
            if(!confirm(`Delete ${selectedIds.size} items?`)) return;
            db = db.filter(i => !selectedIds.has(i.id));
        } else if (action === 'complete') {
            db.forEach(i => { if(selectedIds.has(i.id)) i.completed = true; });
        }
        
        selectedIds.clear();
        save();
        renderList();
    }

    // --- FLASHCARD SYSTEM ---

    function startFlashcards() {
        studyQueue = db.filter(i => !i.completed);
        if(studyQueue.length === 0) return alert("All words mastered! Reset some to study.");
        
        // Shuffle
        studyQueue.sort(() => Math.random() - 0.5);
        
        document.getElementById('fcModal').style.display = 'flex';
        showCard(studyQueue[0]);
    }

    function showCard(item) {
        if(!item) { closeFlashcards(); return alert("Session Done!"); }
        
        const card = document.getElementById('flashcard');
        const details = document.getElementById('fcDetails');
        
        // Reset State
        card.style.transform = 'rotateY(0deg)';
        details.style.display = 'none';
        
        document.getElementById('fcWord').innerText = item.word;
        document.getElementById('fcBangla').innerText = item.bangla || "No Bangla Meanning";
        document.getElementById('fcDef').innerText = item.definition || "No definition";
        document.getElementById('fcNuance').innerText = item.mnemonics || item.nuance || "";
    }

    function flipCard() {
        const details = document.getElementById('fcDetails');
        details.style.display = 'block';
    }

    function nextCard(mastered) {
        const currentItem = studyQueue[0];
        if(mastered) {
            const dbItem = db.find(i => i.id === currentItem.id);
            if(dbItem) dbItem.completed = true;
            save();
            renderList(); // Update background list
            studyQueue.shift(); // Remove from queue
        } else {
            // Move to end of queue to repeat
            studyQueue.push(studyQueue.shift());
        }
        showCard(studyQueue[0]);
    }

    function closeFlashcards() {
        document.getElementById('fcModal').style.display = 'none';
    }

    // --- UTILS ---
    function save() { localStorage.setItem('vocab_v6_pro', JSON.stringify(db)); }
    
    function exportData() {
        const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "vocab_backup.json";
        a.click();
    }

    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }
</script>

</body>
</html>
