<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabMaster AI-Auto V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --accent: #f1f5f9;
        }

        [data-theme="dark"] {
            --primary: #60a5fa;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border: #334155;
            --accent: #334155;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        
        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 20px; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .badge { font-size: 0.7rem; background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; }

        /* INPUT AREA */
        .input-area { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-body); color: var(--text-main); font-size: 1rem; }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--bg-body); color: var(--text-sub); border: 1px solid var(--border); }

        /* LOADING SPINNER */
        .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; display: none; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LIST */
        .vocab-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        
        .card { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; transition: transform 0.2s; }
        
        /* Card Header (Always Visible) */
        .card-header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
        .card-header:hover { background: var(--accent); }
        
        .word-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .pos-tag { font-size: 0.75rem; font-weight: normal; color: var(--text-sub); background: var(--border); padding: 2px 6px; border-radius: 4px; font-style: italic; }

        /* Expanded Details */
        .card-details { display: none; padding: 20px; border-top: 1px solid var(--border); background: var(--bg-body); animation: slideDown 0.3s ease; }
        .card.expanded .card-details { display: block; }
        .card.expanded .arrow { transform: rotate(180deg); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        
        .field-group { display: flex; flex-direction: column; gap: 5px; }
        .label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-sub); letter-spacing: 0.05em; }
        
        .text-box { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text-main); font-family: inherit; resize: vertical; min-height: 40px; box-sizing: border-box;}

        /* Chips for Synonyms */
        .chip-container { display: flex; flex-wrap: wrap; gap: 5px; }
        .chip { font-size: 0.8rem; padding: 4px 8px; border-radius: 15px; background: #e0e7ff; color: #3730a3; }
        .chip.antonym { background: #fee2e2; color: #991b1b; }

        .arrow { transition: transform 0.3s; color: var(--text-sub); }
        .actions { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>VocabAuto <span class="badge">V5 AI</span></h1>
        <div style="display:flex; gap:10px;">
            <button class="btn-secondary" onclick="exportData()">ðŸ’¾ Backup</button>
            <button class="btn-secondary" onclick="toggleTheme()">ðŸŒ— Theme</button>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="wordInput" placeholder="Type a word (e.g. 'Ephemeral') and hit Enter...">
        <button class="btn-primary" id="addBtn" onclick="handleAdd()">
            <span id="btnText">Auto-Add</span>
            <span class="loader" id="loader"></span>
        </button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; padding:0 5px;">
        <span style="font-size:0.9rem; color:gray;" id="countText">0 Words</span>
        <input type="text" id="search" placeholder="Search..." oninput="render()" style="max-width: 200px; padding:8px;">
    </div>

    <ul id="list" class="vocab-list"></ul>
</div>

<script>
    // --- State ---
    let db = JSON.parse(localStorage.getItem('vocab_v5')) || [];

    // --- DOM ---
    const wordInput = document.getElementById('wordInput');
    const listEl = document.getElementById('list');
    const btnText = document.getElementById('btnText');
    const loader = document.getElementById('loader');

    // --- Init ---
    if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    render();

    // --- Input Listener ---
    wordInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleAdd(); });

    // --- Main Logic: Fetch & Add ---
    async function handleAdd() {
        const word = wordInput.value.trim();
        if(!word) return;

        // UI Loading State
        wordInput.disabled = true;
        btnText.style.display = 'none';
        loader.style.display = 'inline-block';

        let newEntry = {
            id: Date.now(),
            word: word, // Capitalize first letter
            definition: "",
            pos: "noun", // part of speech
            synonyms: [],
            antonyms: [],
            nuance: "", // Example sentence or user note
            completed: false,
            created: new Date().toISOString()
        };

        try {
            // 1. CALL API (Free Dictionary API)
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            
            if (res.ok) {
                const data = await res.json();
                const main = data[0];
                const meaning = main.meanings[0];
                
                // Auto-fill logic
                newEntry.word = main.word.charAt(0).toUpperCase() + main.word.slice(1);
                newEntry.pos = meaning.partOfSpeech;
                newEntry.definition = meaning.definitions[0].definition;
                
                // Try to find an example sentence for "Nuance"
                const example = meaning.definitions.find(d => d.example);
                if (example) newEntry.nuance = `Example: "${example.example}"`;

                // Collect synonyms/antonyms from all meanings
                let syns = new Set();
                let ants = new Set();
                main.meanings.forEach(m => {
                    m.synonyms.forEach(s => syns.add(s));
                    m.antonyms.forEach(a => ants.add(a));
                });
                newEntry.synonyms = Array.from(syns).slice(0, 5); // Limit to 5
                newEntry.antonyms = Array.from(ants).slice(0, 3);
            } else {
                // If word not found, just add basically
                newEntry.definition = "Definition not found automatically. Click to edit.";
            }

        } catch (err) {
            console.error(err);
            newEntry.definition = "Offline or Error. Click to edit manually.";
        }

        // Save & Reset
        db.unshift(newEntry);
        save();
        render();
        
        wordInput.value = '';
        wordInput.disabled = false;
        btnText.style.display = 'inline';
        loader.style.display = 'none';
        wordInput.focus();
    }

    // --- Rendering ---
    function render() {
        listEl.innerHTML = '';
        const search = document.getElementById('search').value.toLowerCase();

        db.filter(item => item.word.toLowerCase().includes(search)).forEach(item => {
            const li = document.createElement('li');
            li.className = `card ${item.completed ? 'completed' : ''}`;
            li.id = `card-${item.id}`;
            
            // Synonyms HTML
            const synHtml = item.synonyms.map(s => `<span class="chip">${s}</span>`).join('');
            const antHtml = item.antonyms.map(a => `<span class="chip antonym">${a}</span>`).join('');

            li.innerHTML = `
                <div class="card-header" onclick="toggleExpand(${item.id})">
                    <div class="word-title">
                        ${item.completed ? 'âœ…' : 'ðŸ“–'} ${item.word} 
                        <span class="pos-tag">${item.pos}</span>
                    </div>
                    <div style="font-size:0.9rem; color:gray; margin-right:auto; margin-left:15px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; max-width:40%;">
                        ${item.definition}
                    </div>
                    <span class="arrow">â–¼</span>
                </div>

                <div class="card-details">
                    <div class="field-group">
                        <span class="label">Definition</span>
                        <textarea class="text-box" onchange="updateField(${item.id}, 'definition', this.value)">${item.definition}</textarea>
                    </div>

                    <div class="detail-grid">
                        <div class="field-group">
                            <span class="label">Nuance / Context / Example</span>
                            <textarea class="text-box" style="height:80px" onchange="updateField(${item.id}, 'nuance', this.value)">${item.nuance}</textarea>
                        </div>
                        <div class="field-group">
                            <span class="label">Related Words</span>
                            <div style="margin-bottom:5px;">${synHtml || '<small style="color:gray">No synonyms found</small>'}</div>
                            <div>${antHtml}</div>
                            <input type="text" class="text-box" placeholder="Add synonym manually..." 
                                onkeypress="if(event.key==='Enter') addSynonym(${item.id}, this)">
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-secondary" onclick="deleteItem(${item.id})">Delete</button>
                        <button class="btn-primary" onclick="toggleComplete(${item.id})">
                            ${item.completed ? 'Mark as To-Learn' : 'Mark as Mastered'}
                        </button>
                    </div>
                </div>
            `;
            listEl.appendChild(li);
        });
        document.getElementById('countText').innerText = `${db.length} Words stored`;
    }

    // --- Interactive Functions ---

    function toggleExpand(id) {
        const card = document.getElementById(`card-${id}`);
        card.classList.toggle('expanded');
    }

    function updateField(id, field, value) {
        const item = db.find(i => i.id === id);
        if(item) {
            item[field] = value;
            save();
        }
    }

    function addSynonym(id, input) {
        const val = input.value.trim();
        if(!val) return;
        const item = db.find(i => i.id === id);
        if(item) {
            item.synonyms.push(val);
            save();
            render();
            // Re-open card
            setTimeout(() => document.getElementById(`card-${id}`).classList.add('expanded'), 50);
        }
    }

    function toggleComplete(id) {
        const item = db.find(i => i.id === id);
        item.completed = !item.completed;
        save();
        render();
    }

    function deleteItem(id) {
        if(confirm("Delete this word?")) {
            db = db.filter(i => i.id !== id);
            save();
            render();
        }
    }

    // --- System ---
    function save() { localStorage.setItem('vocab_v5', JSON.stringify(db)); }
    
    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(db, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "vocab_auto_backup.json";
        a.click();
    }
</script>

</body>
</html>